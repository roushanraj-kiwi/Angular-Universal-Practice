/**
 * @license
 * Copyright Google LLC All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
import { createBuilder, targetFromTargetString, } from '@angular-devkit/architect';
import { normalizeOptimization } from '@angular-devkit/build-angular/src/utils/normalize-optimization';
import { augmentAppWithServiceWorker } from '@angular-devkit/build-angular/src/utils/service-worker';
import express from 'express';
import * as http from 'http';
import ora from 'ora';
import { cpus } from 'os';
import * as path from 'path';
import Piscina from 'piscina';
import { promisify } from 'util';
import { getAvailablePort } from '../ssr-dev-server/utils';
import { getRoutes } from './utils';
/**
 * Builds the browser and server, then renders each route in options.routes
 * and writes them to prerender/<route>/index.html for each output path in
 * the browser result.
 */
export async function execute(options, context) {
    const browserTarget = targetFromTargetString(options.browserTarget);
    const browserOptions = (await context.getTargetOptions(browserTarget));
    const routes = await getRoutes(options, browserOptions.tsConfig, context);
    if (!routes.length) {
        throw new Error(`Could not find any routes to generate.`);
    }
    const { result } = await context.scheduleTarget(browserTarget, {
        watch: false,
        serviceWorker: false,
    });
    const { success, error, outputs } = (await result);
    if (!success) {
        return { success, error };
    }
    const { styles: normalizedStylesOptimization } = normalizeOptimization(browserOptions.optimization);
    const worker = createWorker();
    try {
        for (const { path: outputPath } of outputs) {
            const spinner = ora(`Prerendering ${routes.length} route(s) to ${outputPath}...`).start();
            const staticServer = await createStaticServer(outputPath);
            try {
                await Promise.all(routes.map((route) => {
                    const options = {
                        inlineCriticalCss: normalizedStylesOptimization.inlineCritical,
                        outputPath,
                        route,
                        port: staticServer.port,
                    };
                    return worker.run(options, { name: 'render' });
                }));
                spinner.succeed(`Prerendering routes to ${outputPath} complete.`);
                if (browserOptions.serviceWorker) {
                    const swResult = await generateServiceWorker(context, outputPath, browserOptions);
                    if (!swResult.success) {
                        return swResult;
                    }
                }
            }
            catch (error) {
                spinner.fail(`Prerendering routes to ${outputPath} failed.`);
                return { success: false, error: error.message };
            }
            finally {
                await staticServer.close();
            }
        }
        return { success: true };
    }
    finally {
        void worker.destroy();
    }
}
async function createStaticServer(browserOutputRoot) {
    const app = express();
    app.use(express.static(browserOutputRoot));
    const port = await getAvailablePort();
    const server = new http.Server(app);
    await new Promise((res) => server.listen(port, res));
    return {
        close: promisify(server.close.bind(server)),
        port,
    };
}
function createWorker() {
    const maxThreads = Math.max(Math.min(cpus().length, 6) - 1, 1);
    const worker = new Piscina({
        filename: path.join(__dirname, 'worker.js'),
        name: 'render',
        maxThreads,
    });
    return worker;
}
async function generateServiceWorker(context, outputPath, browserOptions) {
    const spinner = ora(`Generating service worker for ${outputPath}...`).start();
    try {
        const projectName = context.target?.project;
        if (!projectName) {
            throw new Error('The builder requires a target.');
        }
        const projectMetadata = await context.getProjectMetadata(projectName);
        const projectRoot = path.join(context.workspaceRoot, projectMetadata.root ?? '');
        await augmentAppWithServiceWorker(projectRoot, context.workspaceRoot, outputPath, browserOptions.baseHref || '/', browserOptions.ngswConfigPath);
        spinner.succeed(`Service worker generation for ${outputPath} complete.`);
        return { success: true };
    }
    catch (error) {
        spinner.fail(`Service worker generation for ${outputPath} failed.`);
        return { success: false, error: error.message };
    }
}
export default createBuilder(execute);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9tb2R1bGVzL2J1aWxkZXJzL3NyYy9zdGF0aWMtZ2VuZXJhdG9yL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7R0FNRztBQUVILE9BQU8sRUFHTCxhQUFhLEVBQ2Isc0JBQXNCLEdBQ3ZCLE1BQU0sMkJBQTJCLENBQUM7QUFFbkMsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sZ0VBQWdFLENBQUM7QUFDdkcsT0FBTyxFQUFFLDJCQUEyQixFQUFFLE1BQU0sd0RBQXdELENBQUM7QUFDckcsT0FBTyxPQUFPLE1BQU0sU0FBUyxDQUFDO0FBQzlCLE9BQU8sS0FBSyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBQzdCLE9BQU8sR0FBRyxNQUFNLEtBQUssQ0FBQztBQUN0QixPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBQzFCLE9BQU8sS0FBSyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBQzdCLE9BQU8sT0FBTyxNQUFNLFNBQVMsQ0FBQztBQUM5QixPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2pDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBRTNELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFHcEM7Ozs7R0FJRztBQUNILE1BQU0sQ0FBQyxLQUFLLFVBQVUsT0FBTyxDQUMzQixPQUFnQyxFQUNoQyxPQUF1QjtJQUV2QixNQUFNLGFBQWEsR0FBRyxzQkFBc0IsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDcEUsTUFBTSxjQUFjLEdBQUcsQ0FBQyxNQUFNLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FDcEQsYUFBYSxDQUNkLENBQXFDLENBQUM7SUFDdkMsTUFBTSxNQUFNLEdBQUcsTUFBTSxTQUFTLENBQUMsT0FBTyxFQUFFLGNBQWMsQ0FB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LE9BQU8sQ0FBQyxhQUFhLEVBQ3BCLGVBQWUsQ0FBQyxJQUEyQixJQUFJLEVBQUUsQ0FDbkQsQ0FBQztRQUVGLE1BQU0sMkJBQTJCLENBQy9CLFdBQVcsRUFDWCxPQUFPLENBQUMsYUFBYSxFQUNyQixVQUFVLEVBQ1YsY0FBYyxDQUFDLFFBQVEsSUFBSSxHQUFHLEVBQzlCLGNBQWMsQ0FBQyxjQUFjLENBQzlCLENBQUM7UUFFRixPQUFPLENBQUMsT0FBTyxDQUFDLGlDQUFpQyxVQUFVLFlBQVksQ0FBQyxDQUFDO1FBRXpFLE9BQU8sRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLENBQUM7S0FDMUI7SUFBQyxPQUFPLEtBQUssRUFBRTtRQUNkLE9BQU8sQ0FBQyxJQUFJLENBQUMsaUNBQWlDLFVBQVUsVUFBVSxDQUFDLENBQUM7UUFFcEUsT0FBTyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQztLQUNqRDtBQUNILENBQUM7QUFFRCxlQUFlLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCBHb29nbGUgTExDIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcbiAqIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgYXQgaHR0cHM6Ly9hbmd1bGFyLmlvL2xpY2Vuc2VcbiAqL1xuXG5pbXBvcnQge1xuICBCdWlsZGVyQ29udGV4dCxcbiAgQnVpbGRlck91dHB1dCxcbiAgY3JlYXRlQnVpbGRlcixcbiAgdGFyZ2V0RnJvbVRhcmdldFN0cmluZyxcbn0gZnJvbSAnQGFuZ3VsYXItZGV2a2l0L2FyY2hpdGVjdCc7XG5pbXBvcnQgeyBCcm93c2VyQnVpbGRlck9wdGlvbnMsIEJyb3dzZXJCdWlsZGVyT3V0cHV0IH0gZnJvbSAnQGFuZ3VsYXItZGV2a2l0L2J1aWxkLWFuZ3VsYXInO1xuaW1wb3J0IHsgbm9ybWFsaXplT3B0aW1pemF0aW9uIH0gZnJvbSAnQGFuZ3VsYXItZGV2a2l0L2J1aWxkLWFuZ3VsYXIvc3JjL3V0aWxzL25vcm1hbGl6ZS1vcHRpbWl6YXRpb24nO1xuaW1wb3J0IHsgYXVnbWVudEFwcFdpdGhTZXJ2aWNlV29ya2VyIH0gZnJvbSAnQGFuZ3VsYXItZGV2a2l0L2J1aWxkLWFuZ3VsYXIvc3JjL3V0aWxzL3NlcnZpY2Utd29ya2VyJztcbmltcG9ydCBleHByZXNzIGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0ICogYXMgaHR0cCBmcm9tICdodHRwJztcbmltcG9ydCBvcmEgZnJvbSAnb3JhJztcbmltcG9ydCB7IGNwdXMgfSBmcm9tICdvcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IFBpc2NpbmEgZnJvbSAncGlzY2luYSc7XG5pbXBvcnQgeyBwcm9taXNpZnkgfSBmcm9tICd1dGlsJztcbmltcG9ydCB7IGdldEF2YWlsYWJsZVBvcnQgfSBmcm9tICcuLi9zc3ItZGV2LXNlcnZlci91dGlscyc7XG5pbXBvcnQgeyBTY2hlbWEgYXMgUHJlcmVuZGVyQnVpbGRlck9wdGlvbnMgfSBmcm9tICcuL3NjaGVtYSc7XG5pbXBvcnQgeyBnZXRSb3V0ZXMgfSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCB7IFJlbmRlck9wdGlvbnMgfSBmcm9tICcuL3dvcmtlcic7XG5cbi8qKlxuICogQnVpbGRzIHRoZSBicm93c2VyIGFuZCBzZXJ2ZXIsIHRoZW4gcmVuZGVycyBlYWNoIHJvdXRlIGluIG9wdGlvbnMucm91dGVzXG4gKiBhbmQgd3JpdGVzIHRoZW0gdG8gcHJlcmVuZGVyLzxyb3V0ZT4vaW5kZXguaHRtbCBmb3IgZWFjaCBvdXRwdXQgcGF0aCBpblxuICogdGhlIGJyb3dzZXIgcmVzdWx0LlxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZXhlY3V0ZShcbiAgb3B0aW9uczogUHJlcmVuZGVyQnVpbGRlck9wdGlvbnMsXG4gIGNvbnRleHQ6IEJ1aWxkZXJDb250ZXh0LFxuKTogUHJvbWlzZTxCdWlsZGVyT3V0cHV0PiB7XG4gIGNvbnN0IGJyb3dzZXJUYXJnZXQgPSB0YXJnZXRGcm9tVGFyZ2V0U3RyaW5nKG9wdGlvbnMuYnJvd3NlclRhcmdldCk7XG4gIGNvbnN0IGJyb3dzZXJPcHRpb25zID0gKGF3YWl0IGNvbnRleHQuZ2V0VGFyZ2V0T3B0aW9ucyhcbiAgICBicm93c2VyVGFyZ2V0LFxuICApKSBhcyB1bmtub3duIGFzIEJyb3dzZXJCdWlsZGVyT3B0aW9ucztcbiAgY29uc3Qgcm91dGVzID0gYXdhaXQgZ2V0Um91dGVzKG9wdGlvbnMsIGJyb3dzZXJPcHRpb25zLnRzQ29uZmlnLCBjb250ZXh0KTtcblxuICBpZiAoIXJvdXRlcy5sZW5ndGgpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBmaW5kIGFueSByb3V0ZXMgdG8gZ2VuZXJhdGUuYCk7XG4gIH1cblxuICBjb25zdCB7IHJlc3VsdCB9ID0gYXdhaXQgY29udGV4dC5zY2hlZHVsZVRhcmdldChicm93c2VyVGFyZ2V0LCB7XG4gICAgd2F0Y2g6IGZhbHNlLFxuICAgIHNlcnZpY2VXb3JrZXI6IGZhbHNlLFxuICB9KTtcblxuICBjb25zdCB7IHN1Y2Nlc3MsIGVycm9yLCBvdXRwdXRzIH0gPSAoYXdhaXQgcmVzdWx0KSBhcyBCcm93c2VyQnVpbGRlck91dHB1dDtcbiAgaWYgKCFzdWNjZXNzKSB7XG4gICAgcmV0dXJuIHsgc3VjY2VzcywgZXJyb3IgfSBhcyBCdWlsZGVyT3V0cHV0O1xuICB9XG5cbiAgY29uc3QgeyBzdHlsZXM6IG5vcm1hbGl6ZWRTdHlsZXNPcHRpbWl6YXRpb24gfSA9IG5vcm1hbGl6ZU9wdGltaXphdGlvbihcbiAgICBicm93c2VyT3B0aW9ucy5vcHRpbWl6YXRpb24sXG4gICk7XG5cbiAgY29uc3Qgd29ya2VyID0gY3JlYXRlV29ya2VyKCk7XG4gIHRyeSB7XG4gICAgZm9yIChjb25zdCB7IHBhdGg6IG91dHB1dFBhdGggfSBvZiBvdXRwdXRzKSB7XG4gICAgICBjb25zdCBzcGlubmVyID0gb3JhKGBQcmVyZW5kZXJpbmcgJHtyb3V0ZXMubGVuZ3RofSByb3V0ZShzKSB0byAke291dHB1dFBhdGh9Li4uYCkuc3RhcnQoKTtcblxuICAgICAgY29uc3Qgc3RhdGljU2VydmVyID0gYXdhaXQgY3JlYXRlU3RhdGljU2VydmVyKG91dHB1dFBhdGgpO1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICAgICAgcm91dGVzLm1hcCgocm91dGUpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG9wdGlvbnM6IFJlbmRlck9wdGlvbnMgPSB7XG4gICAgICAgICAgICAgIGlubGluZUNyaXRpY2FsQ3NzOiBub3JtYWxpemVkU3R5bGVzT3B0aW1pemF0aW9uLmlubGluZUNyaXRpY2FsLFxuICAgICAgICAgICAgICBvdXRwdXRQYXRoLFxuICAgICAgICAgICAgICByb3V0ZSxcbiAgICAgICAgICAgICAgcG9ydDogc3RhdGljU2VydmVyLnBvcnQsXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICByZXR1cm4gd29ya2VyLnJ1bihvcHRpb25zLCB7IG5hbWU6ICdyZW5kZXInIH0pO1xuICAgICAgICAgIH0pLFxuICAgICAgICApO1xuXG4gICAgICAgIHNwaW5uZXIuc3VjY2VlZChgUHJlcmVuZGVyaW5nIHJvdXRlcyB0byAke291dHB1dFBhdGh9IGNvbXBsZXRlLmApO1xuXG4gICAgICAgIGlmIChicm93c2VyT3B0aW9ucy5zZXJ2aWNlV29ya2VyKSB7XG4gICAgICAgICAgY29uc3Qgc3dSZXN1bHQgPSBhd2FpdCBnZW5lcmF0ZVNlcnZpY2VXb3JrZXIoY29udGV4dCwgb3V0cHV0UGF0aCwgYnJvd3Nlck9wdGlvbnMpO1xuICAgICAgICAgIGlmICghc3dSZXN1bHQuc3VjY2Vzcykge1xuICAgICAgICAgICAgcmV0dXJuIHN3UmVzdWx0O1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgc3Bpbm5lci5mYWlsKGBQcmVyZW5kZXJpbmcgcm91dGVzIHRvICR7b3V0cHV0UGF0aH0gZmFpbGVkLmApO1xuXG4gICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogZXJyb3IubWVzc2FnZSB9O1xuICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgYXdhaXQgc3RhdGljU2VydmVyLmNsb3NlKCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSB9O1xuICB9IGZpbmFsbHkge1xuICAgIHZvaWQgd29ya2VyLmRlc3Ryb3koKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBjcmVhdGVTdGF0aWNTZXJ2ZXIoYnJvd3Nlck91dHB1dFJvb3Q6IHN0cmluZyk6IFByb21pc2U8e1xuICBjbG9zZTogKCkgPT4gUHJvbWlzZTx2b2lkPjtcbiAgcG9ydDogbnVtYmVyO1xufT4ge1xuICBjb25zdCBhcHAgPSBleHByZXNzKCk7XG4gIGFwcC51c2UoZXhwcmVzcy5zdGF0aWMoYnJvd3Nlck91dHB1dFJvb3QpKTtcbiAgY29uc3QgcG9ydCA9IGF3YWl0IGdldEF2YWlsYWJsZVBvcnQoKTtcbiAgY29uc3Qgc2VydmVyID0gbmV3IGh0dHAuU2VydmVyKGFwcCk7XG4gIGF3YWl0IG5ldyBQcm9taXNlPHZvaWQ+KChyZXMpID0+IHNlcnZlci5saXN0ZW4ocG9ydCwgcmVzKSk7XG5cbiAgcmV0dXJuIHtcbiAgICBjbG9zZTogcHJvbWlzaWZ5KHNlcnZlci5jbG9zZS5iaW5kKHNlcnZlcikpLFxuICAgIHBvcnQsXG4gIH07XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZVdvcmtlcigpOiBQaXNjaW5hIHtcbiAgY29uc3QgbWF4VGhyZWFkcyA9IE1hdGgubWF4KE1hdGgubWluKGNwdXMoKS5sZW5ndGgsIDYpIC0gMSwgMSk7XG5cbiAgY29uc3Qgd29ya2VyID0gbmV3IFBpc2NpbmEoe1xuICAgIGZpbGVuYW1lOiBwYXRoLmpvaW4oX19kaXJuYW1lLCAnd29ya2VyLmpzJyksXG4gICAgbmFtZTogJ3JlbmRlcicsXG4gICAgbWF4VGhyZWFkcyxcbiAgfSk7XG5cbiAgcmV0dXJuIHdvcmtlcjtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2VuZXJhdGVTZXJ2aWNlV29ya2VyKFxuICBjb250ZXh0OiBCdWlsZGVyQ29udGV4dCxcbiAgb3V0cHV0UGF0aDogc3RyaW5nLFxuICBicm93c2VyT3B0aW9uczogQnJvd3NlckJ1aWxkZXJPcHRpb25zLFxuKTogUHJvbWlzZTxCdWlsZGVyT3V0cHV0PiB7XG4gIGNvbnN0IHNwaW5uZXIgPSBvcmEoYEdlbmVyYXRpbmcgc2VydmljZSB3b3JrZXIgZm9yICR7b3V0cHV0UGF0aH0uLi5gKS5zdGFydCgpO1xuXG4gIHRyeSB7XG4gICAgY29uc3QgcHJvamVjdE5hbWUgPSBjb250ZXh0LnRhcmdldD8ucHJvamVjdDtcbiAgICBpZiAoIXByb2plY3ROYW1lKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBidWlsZGVyIHJlcXVpcmVzIGEgdGFyZ2V0LicpO1xuICAgIH1cblxuICAgIGNvbnN0IHByb2plY3RNZXRhZGF0YSA9IGF3YWl0IGNvbnRleHQuZ2V0UHJvamVjdE1ldGFkYXRhKHByb2plY3ROYW1lKTtcbiAgICBjb25zdCBwcm9qZWN0Um9vdCA9IHBhdGguam9pbihcbiAgICAgIGNvbnRleHQud29ya3NwYWNlUm9vdCxcbiAgICAgIChwcm9qZWN0TWV0YWRhdGEucm9vdCBhcyBzdHJpbmcgfCB1bmRlZmluZWQpID8/ICcnLFxuICAgICk7XG5cbiAgICBhd2FpdCBhdWdtZW50QXBwV2l0aFNlcnZpY2VXb3JrZXIoXG4gICAgICBwcm9qZWN0Um9vdCxcbiAgICAgIGNvbnRleHQud29ya3NwYWNlUm9vdCxcbiAgICAgIG91dHB1dFBhdGgsXG4gICAgICBicm93c2VyT3B0aW9ucy5iYXNlSHJlZiB8fCAnLycsXG4gICAgICBicm93c2VyT3B0aW9ucy5uZ3N3Q29uZmlnUGF0aCxcbiAgICApO1xuXG4gICAgc3Bpbm5lci5zdWNjZWVkKGBTZXJ2aWNlIHdvcmtlciBnZW5lcmF0aW9uIGZvciAke291dHB1dFBhdGh9IGNvbXBsZXRlLmApO1xuXG4gICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSB9O1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIHNwaW5uZXIuZmFpbChgU2VydmljZSB3b3JrZXIgZ2VuZXJhdGlvbiBmb3IgJHtvdXRwdXRQYXRofSBmYWlsZWQuYCk7XG5cbiAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6IGVycm9yLm1lc3NhZ2UgfTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBjcmVhdGVCdWlsZGVyKGV4ZWN1dGUpO1xuIl19